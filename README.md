# Go2 Hierarchical Reach-Avoid RL

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

Go2 Hierarchical Reach-Avoid RL æ˜¯ä¸€ä¸ªåŸºäºå¼ºåŒ–å­¦ä¹ çš„æœºå™¨äººå¯¼èˆªç³»ç»Ÿï¼Œä¸“ä¸º Unitree Go2 æœºå™¨äººè®¾è®¡ã€‚è¯¥é¡¹ç›®å®ç°äº†ä¸€ä¸ªåˆ†å±‚æ§åˆ¶æ¶æ„ï¼Œç»“åˆäº†é¢„è®­ç»ƒçš„ä½å±‚çº§è¿åŠ¨ç­–ç•¥å’Œå¯è®­ç»ƒçš„é«˜å±‚çº§å¯¼èˆªç­–ç•¥ï¼Œä½¿æœºå™¨äººèƒ½å¤Ÿåœ¨å¤æ‚ç¯å¢ƒä¸­å®‰å…¨å¯¼èˆªå¹¶åˆ°è¾¾ç›®æ ‡ä½ç½®ã€‚

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

### ğŸ¯ 1. åˆ†å±‚æ§åˆ¶æ¶æ„

#### ä½å±‚çº§ï¼ˆLocomotionï¼‰
- **åŠŸèƒ½**ï¼šå°†é€Ÿåº¦æŒ‡ä»¤ï¼ˆçº¿é€Ÿåº¦å’Œè§’é€Ÿåº¦ï¼‰è½¬æ¢ä¸ºæœºå™¨äººçš„å…³èŠ‚åŠ¨ä½œ
- **å®ç°**ï¼šé¢„è®­ç»ƒçš„è¿åŠ¨æ§åˆ¶ç­–ç•¥ï¼ŒåŸºäº PPO ç®—æ³•è®­ç»ƒ
- **è¾“å…¥**ï¼šæœºå™¨äººçŠ¶æ€ï¼ˆå…³èŠ‚è§’åº¦ã€é€Ÿåº¦ã€IMU æ•°æ®ç­‰ï¼‰å’Œé€Ÿåº¦æŒ‡ä»¤
- **è¾“å‡º**ï¼šå…³èŠ‚ç›®æ ‡ä½ç½®æˆ–åŠ›çŸ©
- **æ–‡ä»¶ä½ç½®**ï¼š
  - ç¯å¢ƒå°è£…ï¼š`legged_gym/envs/go2/go2_env.py`
  - ä½å±‚çº§ç­–ç•¥åŠ è½½ï¼š`legged_gym/envs/go2/hierarchical_go2_env.py` ä¸­çš„ `_load_low_level_policy` æ–¹æ³•

#### é«˜å±‚çº§ï¼ˆNavigationï¼‰
- **åŠŸèƒ½**ï¼šå°†ç¯å¢ƒè§‚æµ‹è½¬æ¢ä¸ºé€Ÿåº¦æŒ‡ä»¤ï¼Œå®ç°é¿éšœå¯¼èˆª
- **å®ç°**ï¼šå¯è®­ç»ƒçš„å¯¼èˆªç­–ç•¥ï¼ŒåŸºäº Reach-Avoid PPO ç®—æ³•
- **è¾“å…¥**ï¼šç¯å¢ƒè§‚æµ‹ï¼ˆæœºå™¨äººä½ç½®ã€éšœç¢ç‰©ä¿¡æ¯ã€ç›®æ ‡ä½ç½®ã€é€Ÿåº¦ç­‰ï¼‰
- **è¾“å‡º**ï¼šé€Ÿåº¦æŒ‡ä»¤ï¼ˆçº¿é€Ÿåº¦å’Œè§’é€Ÿåº¦ï¼‰
- **æ–‡ä»¶ä½ç½®**ï¼š
  - å¯¼èˆªç¯å¢ƒï¼š`legged_gym/envs/go2/high_level_navigation_env.py`
  - é«˜å±‚çº§é…ç½®ï¼š`legged_gym/envs/go2/high_level_navigation_env.py` ä¸­çš„ `HighLevelNavigationConfig` ç±»

#### å±‚çº§è¿æ¥æœºåˆ¶
- **åŠ¨ä½œé‡å¤æœºåˆ¶**ï¼šé«˜å±‚çº§è¾“å‡ºçš„é€Ÿåº¦æŒ‡ä»¤åœ¨ä½å±‚çº§é‡å¤æ‰§è¡Œå¤šæ¬¡
- **å‚æ•°é…ç½®**ï¼šé€šè¿‡ `high_level_action_repeat` å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤ä¸º 1
- **æ–‡ä»¶ä½ç½®**ï¼š`legged_gym/envs/go2/hierarchical_go2_env.py` ä¸­çš„ `low_level_action_repeat` å±æ€§

#### åˆ†å±‚ç¯å¢ƒå°è£…
- **ç»Ÿä¸€æ¥å£**ï¼š`HierarchicalVecEnv` ç±»å°è£…äº†åˆ†å±‚ç¯å¢ƒï¼Œæä¾›æ ‡å‡†çš„ RL ç¯å¢ƒæ¥å£
- **æ–‡ä»¶ä½ç½®**ï¼š`legged_gym/scripts/train_reach_avoid.py` ä¸­çš„ `HierarchicalVecEnv` ç±»
- **æ ¸å¿ƒæ–¹æ³•**ï¼š`reset()`ã€`step()`ã€`close()`

### ğŸ§  2. Reach-Avoid å¼ºåŒ–å­¦ä¹ ç®—æ³•

Reach-Avoid å¼ºåŒ–å­¦ä¹ ç®—æ³•æ˜¯ä¸“ä¸ºé¿éšœå¯¼èˆªä»»åŠ¡è®¾è®¡çš„ PPOï¼ˆProximal Policy Optimizationï¼‰æ‰©å±•ç‰ˆæœ¬ï¼Œå®ç°äº†åˆ°è¾¾ç›®æ ‡ä½ç½®ï¼ˆreachï¼‰å’Œé¿å…éšœç¢ç‰©ï¼ˆavoidï¼‰çš„åŒé‡ç›®æ ‡ã€‚

#### 2.1 æ ¸å¿ƒé—®é¢˜å®šä¹‰

- **Reach ç›®æ ‡**ï¼šæœºå™¨äººéœ€è¦åˆ°è¾¾æŒ‡å®šç›®æ ‡ä½ç½®ï¼Œç”± `g_values` è¡¨ç¤ºï¼ˆè´Ÿå€¼è¡¨ç¤ºæˆåŠŸåˆ°è¾¾ï¼‰
- **Avoid çº¦æŸ**ï¼šæœºå™¨äººå¿…é¡»é¿å…ä¸éšœç¢ç‰©ç¢°æ’ï¼Œç”± `h_values` è¡¨ç¤ºï¼ˆéè´Ÿå€¼è¡¨ç¤ºç¢°æ’ï¼‰
- **çŠ¶æ€ç©ºé—´**ï¼šæœºå™¨äººä½ç½®ã€é€Ÿåº¦ã€éšœç¢ç‰©ä¿¡æ¯ã€ç›®æ ‡ä½ç½®ç­‰ç¯å¢ƒè§‚æµ‹
- **åŠ¨ä½œç©ºé—´**ï¼šé€Ÿåº¦æŒ‡ä»¤ï¼ˆçº¿é€Ÿåº¦å’Œè§’é€Ÿåº¦ï¼‰

#### 2.2 ç®—æ³•æ ¸å¿ƒç»„ä»¶

##### ReachAvoidPPO ç±»
- **åŠŸèƒ½**ï¼šå®ç°å®Œæ•´çš„ Reach-Avoid PPO ç®—æ³•
- **æ–‡ä»¶ä½ç½®**ï¼š`rsl_rl/algorithms/reach_avoid_ppo.py`
- **æ ¸å¿ƒæ–¹æ³•**ï¼š
  - `act()`ï¼šæ ¹æ®è§‚æµ‹ç”ŸæˆåŠ¨ä½œ
  - `update()`ï¼šæ›´æ–°ç­–ç•¥ç½‘ç»œ
  - `init_storage()`ï¼šåˆå§‹åŒ–ç»éªŒç¼“å†²åŒº

##### è‡ªå®šä¹‰ä¼˜åŠ¿å‡½æ•°è®¡ç®—
- **åŠŸèƒ½**ï¼šè®¡ç®—é€‚ç”¨äº Reach-Avoid ä»»åŠ¡çš„å¹¿ä¹‰ä¼˜åŠ¿ä¼°è®¡ï¼ˆGAEï¼‰
- **å®ç°**ï¼š`_calculate_reach_gae` å‡½æ•°
- **ç‰¹ç‚¹**ï¼š
  - è€ƒè™‘äº† reach å’Œ avoid åŒé‡ç›®æ ‡
  - åŸºäº JAX å‚è€ƒå®ç°çš„ PyTorch ç§»æ¤
  - æ”¯æŒå¤šç¯å¢ƒå¹¶è¡Œè®¡ç®—
- **æ–‡ä»¶ä½ç½®**ï¼š`rsl_rl/algorithms/reach_avoid_ppo.py` ä¸­çš„ `_calculate_reach_gae` å‡½æ•°

##### ç»éªŒå›æ”¾ç¼“å†²åŒº
- **åŠŸèƒ½**ï¼šå­˜å‚¨å’Œç®¡ç†è®­ç»ƒæ•°æ®
- **å®ç°**ï¼š`ReachAvoidBuffer` ç±»
- **ç‰¹ç‚¹**ï¼š
  - å­˜å‚¨ `g_values` å’Œ `h_values` ç”¨äºé¿éšœä»»åŠ¡
  - æ”¯æŒæ‰¹é‡é‡‡æ ·å’Œå¤šè½®è®­ç»ƒ
  - å®ç°äº†è‡ªå®šä¹‰çš„ä¼˜åŠ¿å‡½æ•°è®¡ç®—
- **æ–‡ä»¶ä½ç½®**ï¼š`rsl_rl/algorithms/reach_avoid_ppo.py` ä¸­çš„ `ReachAvoidBuffer` ç±»

##### æ•°æ®æ‰¹æ¬¡å¤„ç†
- **åŠŸèƒ½**ï¼šå°†ç»éªŒæ•°æ®è½¬æ¢ä¸ºè®­ç»ƒæ‰¹æ¬¡
- **å®ç°**ï¼š`ReachAvoidBatch` æ•°æ®ç±»
- **ç‰¹ç‚¹**ï¼š
  - å°è£…äº†è®­ç»ƒæ‰€éœ€çš„æ‰€æœ‰æ•°æ®
  - æ”¯æŒæ‰å¹³åŒ–æ•°æ®è§†å›¾
  - ä¾¿äºæ‰¹é‡é‡‡æ ·å’Œè®­ç»ƒ
- **æ–‡ä»¶ä½ç½®**ï¼š`rsl_rl/algorithms/reach_avoid_ppo.py` ä¸­çš„ `ReachAvoidBatch` ç±»

#### 2.3 ç®—æ³•æ›´æ–°æµç¨‹

1. **ç»éªŒæ”¶é›†**ï¼šé€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ”¶é›†è½¨è¿¹æ•°æ®
2. **å®Œæˆæ ‡å¿—è®¡ç®—**ï¼š
   - ç¯å¢ƒå®Œæˆï¼š`env_dones = self.dones`
   - å®‰å…¨è¿è§„ï¼š`safety_dones = self.h_values[:-1] >= 0`
   - æœ€ç»ˆå®Œæˆæ ‡å¿—ï¼š`done_seq = torch.logical_or(env_dones, safety_dones)`
3. **ä¼˜åŠ¿å‡½æ•°è®¡ç®—**ï¼šè°ƒç”¨ `_calculate_reach_gae` è®¡ç®—ä¼˜åŠ¿å’Œç›®æ ‡å€¼
4. **ä¼˜åŠ¿å½’ä¸€åŒ–**ï¼šå¯¹ä¼˜åŠ¿å‡½æ•°è¿›è¡Œå½’ä¸€åŒ–å¤„ç†
5. **ç­–ç•¥æ›´æ–°**ï¼š
   - è®¡ç®—æ–°çš„åŠ¨ä½œæ¦‚ç‡å’Œä»·å€¼ä¼°è®¡
   - è®¡ç®—ç­–ç•¥æŸå¤±ï¼ˆè£å‰ªç›®æ ‡ï¼‰
   - è®¡ç®—ä»·å€¼æŸå¤±ï¼ˆè£å‰ªç›®æ ‡ï¼‰
   - è®¡ç®—ç†µæ­£åˆ™åŒ–é¡¹
   - æ€»æŸå¤±ï¼š`loss = policy_loss + value_loss_coef * value_loss - entropy_coef * entropy`
   - åå‘ä¼ æ’­å’Œæ¢¯åº¦è£å‰ª
   - ä¼˜åŒ–å™¨æ›´æ–°

#### 2.4 å…³é”®å‚æ•°é…ç½®

| å‚æ•° | æè¿° | é»˜è®¤å€¼ |
|------|------|--------|
| `learning_rate` | å­¦ä¹ ç‡ | 3e-4 |
| `gamma` | æŠ˜æ‰£å› å­ | 0.999 |
| `lam` | GAE å‚æ•° | 0.95 |
| `num_learning_epochs` | æ¯æ¬¡è¿­ä»£çš„è®­ç»ƒè½®æ•° | 4 |
| `num_mini_batches` | æ¯æ¬¡è¿­ä»£çš„ mini-batch æ•°é‡ | 4 |
| `clip_param` | PPO è£å‰ªå‚æ•° | 0.2 |
| `value_loss_coef` | ä»·å€¼æŸå¤±æƒé‡ | 1.0 |
| `entropy_coef` | ç†µæ­£åˆ™åŒ–æƒé‡ | 0.0 |
| `max_grad_norm` | æ¢¯åº¦è£å‰ªé˜ˆå€¼ | 1.0 |

#### 2.5 æˆåŠŸæŒ‡æ ‡è®¡ç®—

- **åŠŸèƒ½**ï¼šè¯„ä¼°æœºå™¨äººåœ¨è½¨è¿¹ä¸­çš„é¿éšœå¯¼èˆªæˆåŠŸç‡
- **å®ç°**ï¼š`compute_reach_avoid_success_rate` å‡½æ•°
- **è®¡ç®—é€»è¾‘**ï¼š
  1. æ£€æŸ¥æ˜¯å¦æˆåŠŸåˆ°è¾¾ç›®æ ‡ï¼ˆ`g_values < 0`ï¼‰
  2. è®°å½•é¦–æ¬¡æˆåŠŸåˆ°è¾¾çš„æ—¶é—´æ­¥
  3. æ£€æŸ¥åœ¨æˆåŠŸå‰æ˜¯å¦å‘ç”Ÿç¢°æ’ï¼ˆ`h_values >= 0`ï¼‰
  4. æˆåŠŸç‡ = ï¼ˆæˆåŠŸåˆ°è¾¾ç›®æ ‡ä¸”æœªç¢°æ’çš„ç¯å¢ƒæ•°ï¼‰/ æ€»ç¯å¢ƒæ•°
- **æ–‡ä»¶ä½ç½®**ï¼š`legged_gym/scripts/train_reach_avoid.py` ä¸­çš„ `compute_reach_avoid_success_rate` å‡½æ•°

#### 2.6 ä¸æ ‡å‡† PPO çš„åŒºåˆ«

1. **ç›®æ ‡å‡½æ•°**ï¼š
   - æ ‡å‡† PPOï¼šå•ä¸€å¥–åŠ±ä¿¡å·
   - ReachAvoidPPOï¼šåŒé‡ç›®æ ‡ï¼ˆreach + avoidï¼‰

2. **ä¼˜åŠ¿å‡½æ•°**ï¼š
   - æ ‡å‡† PPOï¼šåŸºäºå¥–åŠ±ä¿¡å·çš„ GAE
   - ReachAvoidPPOï¼šåŸºäº `g_values` å’Œ `h_values` çš„è‡ªå®šä¹‰ GAE

3. **å®Œæˆæ ‡å¿—**ï¼š
   - æ ‡å‡† PPOï¼šä»…ç¯å¢ƒå®Œæˆ
   - ReachAvoidPPOï¼šç¯å¢ƒå®Œæˆæˆ–å®‰å…¨è¿è§„

4. **ç»éªŒç¼“å†²åŒº**ï¼š
   - æ ‡å‡† PPOï¼šå­˜å‚¨å¥–åŠ±å’Œå®Œæˆæ ‡å¿—
   - ReachAvoidPPOï¼šé¢å¤–å­˜å‚¨ `g_values` å’Œ `h_values`

5. **è®­ç»ƒæµç¨‹**ï¼š
   - æ ‡å‡† PPOï¼šåŸºäºå¥–åŠ±çš„ç­–ç•¥æ›´æ–°
   - ReachAvoidPPOï¼šè€ƒè™‘åŒé‡ç›®æ ‡çš„ç­–ç•¥æ›´æ–°

### ğŸŒ 3. ç¯å¢ƒä¸ä»¿çœŸ

- åŸºäº Isaac Gym ç‰©ç†å¼•æ“çš„é«˜æ€§èƒ½ä»¿çœŸç¯å¢ƒ
- æ”¯æŒå¤šç¯å¢ƒå¹¶è¡Œè®­ç»ƒ
- æä¾›ä¸°å¯Œçš„ç¯å¢ƒè§‚æµ‹å’Œå¥–åŠ±ä¿¡å·

### ğŸ“‹ 4. è®­ç»ƒæµç¨‹

æ‰§è¡Œ `train_reach_avoid.py` åï¼Œé¡¹ç›®å°†å¯åŠ¨å®Œæ•´çš„è®­ç»ƒæµç¨‹ï¼š

1. **ç¯å¢ƒåˆå§‹åŒ–**ï¼šåˆ›å»º Go2 æœºå™¨äººä»¿çœŸç¯å¢ƒ
2. **ä½å±‚çº§ç­–ç•¥åŠ è½½**ï¼šåŠ è½½é¢„è®­ç»ƒçš„è¿åŠ¨æ§åˆ¶ç­–ç•¥
3. **é«˜å±‚çº§ç­–ç•¥åˆå§‹åŒ–**ï¼šåˆå§‹åŒ–å¯¼èˆªç­–ç•¥ç½‘ç»œ
4. **ç»éªŒæ”¶é›†**ï¼šé€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ”¶é›†è½¨è¿¹æ•°æ®
5. **ç­–ç•¥æ›´æ–°**ï¼šä½¿ç”¨ PPO ç®—æ³•æ›´æ–°é«˜å±‚çº§å¯¼èˆªç­–ç•¥
6. **æ€§èƒ½è¯„ä¼°**ï¼šè®¡ç®—å¹¶ç›‘æ§é¿éšœä»»åŠ¡æˆåŠŸç‡
7. **æ¨¡å‹ä¿å­˜**ï¼šå®šæœŸä¿å­˜è®­ç»ƒå¥½çš„æ¨¡å‹æ£€æŸ¥ç‚¹

## ğŸ“ æŠ€æœ¯æ¶æ„

### ğŸ§© ä¸»è¦ç»„ä»¶

| ç»„ä»¶ | æè¿° | ä½ç½® |
|------|------|------|
| HierarchicalGO2Env | åˆ†å±‚ç¯å¢ƒå°è£… | `legged_gym/envs/go2/hierarchical_go2_env.py` |
| ReachAvoidPPO | é¿éšœå¼ºåŒ–å­¦ä¹ ç®—æ³• | `rsl_rl/algorithms/reach_avoid_ppo.py` |
| ActorCritic | ç­–ç•¥ç½‘ç»œæ¶æ„ | `rsl_rl/modules/actor_critic.py` |
| HighLevelNavigationEnv | é«˜å±‚çº§å¯¼èˆªå°è£… | `legged_gym/envs/go2/high_level_navigation_env.py` |

### ğŸ—ï¸ ç½‘ç»œæ¶æ„

- **Actor ç½‘ç»œ**ï¼š4 å±‚å…¨è¿æ¥ç½‘ç»œï¼Œæ¯å±‚ 512 ä¸ªå•å…ƒ
- **Critic ç½‘ç»œ**ï¼š4 å±‚å…¨è¿æ¥ç½‘ç»œï¼Œæ¯å±‚ 512 ä¸ªå•å…ƒ
- æ¿€æ´»å‡½æ•°ï¼šReLU
- åˆå§‹åŒ–å™ªå£°ï¼šæ ‡å‡†å·®ä¸º 0.1 çš„é«˜æ–¯å™ªå£°

## ğŸ“¦ ç¯å¢ƒé…ç½®

### ğŸ“¥ å®‰è£…æ­¥éª¤

#### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**ï¼šæ¨è Ubuntu 18.04 æˆ–æ›´é«˜ç‰ˆæœ¬
- **GPU**ï¼šNVIDIA GPU
- **é©±åŠ¨ç‰ˆæœ¬**ï¼šæ¨è 525 æˆ–æ›´é«˜ç‰ˆæœ¬

#### è¯¦ç»†å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®ä»“åº“**
   ```bash
   git clone https://github.com/haoyangc2001/Go2HierarchicalReachAvoidRL.git
   cd Go2HierarchicalReachAvoidRL
   ```

2. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èä½¿ç”¨ Condaï¼‰**
   
   å»ºè®®åœ¨è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œè®­ç»ƒæˆ–éƒ¨ç½²ç¨‹åºï¼Œæ¨èä½¿ç”¨ Conda åˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€‚å¦‚æœæ‚¨çš„ç³»ç»Ÿä¸­å·²ç»å®‰è£…äº† Condaï¼Œå¯ä»¥è·³è¿‡æ­¥éª¤ 2.1ã€‚

   #### 2.1 ä¸‹è½½å¹¶å®‰è£… MiniConda
   MiniConda æ˜¯ Conda çš„è½»é‡çº§å‘è¡Œç‰ˆï¼Œé€‚ç”¨äºåˆ›å»ºå’Œç®¡ç†è™šæ‹Ÿç¯å¢ƒã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸‹è½½å¹¶å®‰è£…ï¼š
   ```bash
   mkdir -p ~/miniconda3
   wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda3/miniconda.sh
   bash ~/miniconda3/miniconda.sh -b -u -p ~/miniconda3
   rm ~/miniconda3/miniconda.sh
   ```

   å®‰è£…å®Œæˆåï¼Œåˆå§‹åŒ– Condaï¼š
   ```bash
   ~/miniconda3/bin/conda init --all
   source ~/.bashrc
   ```

   #### 2.2 åˆ›å»ºæ–°ç¯å¢ƒ
   ```bash
   conda create -n unitree-rl python=3.8
   ```

   #### 2.3 æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
   ```bash
   conda activate unitree-rl
   ```

3. **å®‰è£…ä¾èµ–é¡¹**
   
   #### 3.1 å®‰è£… PyTorch
   PyTorch æ˜¯ä¸€ä¸ªç¥ç»ç½‘ç»œè®¡ç®—æ¡†æ¶ï¼Œç”¨äºæ¨¡å‹è®­ç»ƒå’Œæ¨ç†ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
   ```bash
   conda install pytorch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1 pytorch-cuda=12.1 -c pytorch -c nvidia
   ```
   
   #### 3.2 å®‰è£… Isaac Gym
   Isaac Gym æ˜¯ Nvidia æä¾›çš„åˆšä½“ä»¿çœŸå’Œè®­ç»ƒæ¡†æ¶ã€‚

   ##### 3.2.1 ä¸‹è½½
   ä» Nvidia å®˜ç½‘ä¸‹è½½ [Isaac Gym](https://developer.nvidia.com/isaac-gym)ã€‚

   ##### 3.2.2 å®‰è£…
   è§£å‹åè¿›å…¥ `isaacgym/python` æ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
   ```bash
   cd isaacgym/python
   pip install -e .
   ```

   ##### 3.2.3 éªŒè¯å®‰è£…
   è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè‹¥å¼¹å‡ºçª—å£å¹¶æ˜¾ç¤º 1080 ä¸ªçƒä¸‹è½ï¼Œåˆ™å®‰è£…æˆåŠŸï¼š
   ```bash
   cd examples
   python 1080_balls_of_solitude.py
   ```

   å¦‚æœ‰é—®é¢˜ï¼Œå¯å‚è€ƒ `isaacgym/docs/index.html` ä¸­çš„å®˜æ–¹æ–‡æ¡£ã€‚

   #### 3.3 å®‰è£… rsl_rl
   `rsl_rl` æ˜¯ä¸€ä¸ªå¼ºåŒ–å­¦ä¹ ç®—æ³•åº“ã€‚

   ##### 3.3.1 ä¸‹è½½
   é€šè¿‡ Git å…‹éš†ä»“åº“ï¼š
   ```bash
   cd ..
   cd ..
   git clone https://github.com/leggedrobotics/rsl_rl.git
   ```

   ##### 3.3.2 åˆ‡æ¢åˆ†æ”¯
   åˆ‡æ¢åˆ° v1.0.2 åˆ†æ”¯ï¼š
   ```bash
   cd rsl_rl
   git checkout v1.0.2
   ```

   ##### 3.3.3 å®‰è£…
   ```bash
   pip install -e .
   cd ..
   ```

   #### 3.3.4 å®‰è£… unitree_rl_gym
   `unitree_rl_gym` æ˜¯ Unitree æœºå™¨äººå¼ºåŒ–å­¦ä¹ åŸºç¡€åº“ã€‚

   ##### 3.3.4.1 ä¸‹è½½
   é€šè¿‡ Git å…‹éš†ä»“åº“ï¼š
   ```bash
   git clone https://github.com/unitreerobotics/unitree_rl_gym.git
   ```

   ##### 3.3.4.2 å®‰è£…
   è¿›å…¥ç›®å½•å¹¶å®‰è£…ï¼š
   ```bash
   cd unitree_rl_gym
   pip install -e .
   cd ..
   ```

   #### 3.4 å®‰è£…é¡¹ç›®ä¾èµ–
   ```bash
   cd legged_gym_go2
   pip install -e .
   
   # å®‰è£…å…¶ä»–ä¾èµ–
   pip install numpy matplotlib torchvision
   ```


## ğŸ› ï¸ ä½¿ç”¨è¯´æ˜

### ğŸ“œ è„šæœ¬è¯´æ˜

`legged_gym_go2/legged_gym/scripts/` ç›®å½•ä¸‹åŒ…å«ä»¥ä¸‹æ ¸å¿ƒè„šæœ¬ï¼š

#### 1. è®­ç»ƒè„šæœ¬

##### `train_reach_avoid.py`
- **åŠŸèƒ½**ï¼šå®ç°åˆ†å±‚é¿éšœä»»åŠ¡çš„å®Œæ•´è®­ç»ƒæµç¨‹ï¼Œç»“åˆé¢„è®­ç»ƒçš„ä½å±‚çº§è¿åŠ¨ç­–ç•¥å’Œå¯è®­ç»ƒçš„é«˜å±‚çº§å¯¼èˆªç­–ç•¥
- **ç®—æ³•**ï¼šåŸºäº Reach-Avoid PPO ç®—æ³•
- **ä½¿ç”¨å‘½ä»¤**ï¼š
  ```bash
  python legged_gym_go2/legged_gym/scripts/train_reach_avoid.py
  ```
- **ä¸»è¦å‚æ•°**ï¼š
  - `--headless`ï¼šæ˜¯å¦åœ¨æ— å¤´æ¨¡å¼ä¸‹è¿è¡Œï¼ˆé»˜è®¤ï¼šTrueï¼‰
  - `--resume`ï¼šæ˜¯å¦ä» checkpoint æ¢å¤è®­ç»ƒ
  - `--experiment_name`ï¼šå®éªŒåç§°
  - `--num_envs`ï¼šå¹¶è¡Œè®­ç»ƒç¯å¢ƒæ•°é‡

#### 2. å¯è§†åŒ–ä¸æµ‹è¯•è„šæœ¬

##### `play_reach_avoid.py`
- **åŠŸèƒ½**ï¼šå¯è§†åŒ–è®­ç»ƒåçš„åˆ†å±‚é¿éšœç­–ç•¥æ•ˆæœï¼Œå±•ç¤ºæœºå™¨äººåœ¨å¤æ‚ç¯å¢ƒä¸­å¯¼èˆªé¿éšœçš„èƒ½åŠ›
- **ä½¿ç”¨å‘½ä»¤**ï¼š
  ```bash
  python legged_gym_go2/legged_gym/scripts/play_reach_avoid.py
  ```
- **ä¸»è¦å‚æ•°**ï¼š
  - `--model_path`ï¼šæŒ‡å®šæ¨¡å‹è·¯å¾„
  - `--headless`ï¼šæ˜¯å¦åœ¨æ— å¤´æ¨¡å¼ä¸‹è¿è¡Œ

##### `play_fixed_commands_with_video.py`
- **åŠŸèƒ½**ï¼šä½¿ç”¨å›ºå®šå‘½ä»¤åºåˆ—æµ‹è¯•æœºå™¨äººçš„è¿åŠ¨æ§åˆ¶èƒ½åŠ›ï¼Œå¹¶æ”¯æŒè§†é¢‘å½•åˆ¶
- **æµ‹è¯•å‘½ä»¤**ï¼šåŒ…å«åœæ­¢ã€å‰è¿›ã€å³ç§»ã€å³è½¬ç­‰é¢„è®¾å‘½ä»¤åºåˆ—
- **ä½¿ç”¨å‘½ä»¤**ï¼š
  ```bash
  python legged_gym_go2/legged_gym/scripts/play_fixed_commands_with_video.py --task=go2
  ```
- **ä¸»è¦å‚æ•°**ï¼š
  - `--task`ï¼šæœºå™¨äººç±»å‹ï¼ˆå›ºå®šä¸º go2ï¼‰
  - `--headless`ï¼šæ˜¯å¦åœ¨æ— å¤´æ¨¡å¼ä¸‹è¿è¡Œ

##### `plot_env_layout.py`
- **åŠŸèƒ½**ï¼šå¯è§†åŒ– GO2 é«˜å±‚çº§ç¯å¢ƒå¸ƒå±€ï¼ˆç›®æ ‡+éšœç¢ç‰©ï¼‰ï¼Œå¹¶å¯å åŠ æµ‹è¯•è½¨è¿¹
- **ä½¿ç”¨å‘½ä»¤**ï¼š
  ```bash
  python legged_gym_go2/legged_gym/scripts/plot_env_layout.py
  ```
- **ä¸»è¦å‚æ•°**ï¼š
  - `--traj-file`ï¼šå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šç”± test_reach_avoid.py ç”Ÿæˆçš„ JSON è½¨è¿¹æ–‡ä»¶
  - `--save`ï¼šå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå›¾åƒä¿å­˜è·¯å¾„
  - `--no-show`ï¼šè·³è¿‡äº¤äº’å¼çª—å£ï¼ˆç”¨äºä¿å­˜åˆ°ç£ç›˜æ—¶ï¼‰

##### `test_reach_avoid.py`
- **åŠŸèƒ½**ï¼šåŠ è½½è®­ç»ƒå¥½çš„é«˜å±‚çº§reach-avoidç­–ç•¥ï¼Œç”Ÿæˆå¤šä¸ªéšæœºè½¨è¿¹ï¼Œå¹¶å°†XYè·¯å¾„ä¿å­˜åˆ°JSONæ–‡ä»¶ä¸­ï¼Œä¾›åç»­ä½¿ç”¨plot_env_layout.pyå¯è§†åŒ–
- **ä½¿ç”¨å‘½ä»¤**ï¼š
  ```bash
  python legged_gym_go2/legged_gym/scripts/test_reach_avoid.py --checkpoint-path <model_path> --output traj_run.json
  ```
- **ä¸»è¦å‚æ•°**ï¼š
  - `--checkpoint-path`ï¼šå¿…é¡»å‚æ•°ï¼ŒæŒ‡å®šè®­ç»ƒå¥½çš„é«˜å±‚çº§checkpointè·¯å¾„ï¼ˆ.ptæ–‡ä»¶ï¼‰
  - `--num-trajs`ï¼šè¦è®°å½•çš„è½¨è¿¹æ•°é‡ï¼ˆé»˜è®¤ï¼š10ï¼‰
  - `--max-steps`ï¼šæ¯ä¸ªè½¨è¿¹çš„æœ€å¤§é«˜å±‚çº§æ­¥æ•°ï¼ˆé»˜è®¤ï¼š500ï¼‰
  - `--output`ï¼šå­˜å‚¨XYè·¯å¾„çš„JSONæ–‡ä»¶åç§°ï¼ˆé»˜è®¤ï¼šreach_avoid_rollouts.jsonï¼‰
  - `--low-level-model`ï¼šå¯é€‰çš„é¢„è®­ç»ƒä½å±‚çº§è¿åŠ¨ç­–ç•¥è¦†ç›–
  - `--num-envs`ï¼šç”¨äºrolloutsçš„å¹¶è¡Œç¯å¢ƒæ•°é‡ï¼ˆé»˜è®¤ï¼š1ï¼‰
  - `--render`ï¼šåœ¨rolloutsæœŸé—´æ‰“å¼€Isaac GymæŸ¥çœ‹å™¨
  - `--max-reset-attempts`ï¼šç¯å¢ƒé‡ç½®å°è¯•çš„å®‰å…¨ä¸Šé™ï¼ˆé»˜è®¤ï¼š20ï¼‰

### âš™ï¸ å‘½ä»¤è¡Œå‚æ•°

æ‰€æœ‰è„šæœ¬æ”¯æŒçš„é€šç”¨å‚æ•°ï¼š

| å‚æ•° | æè¿° | é»˜è®¤å€¼ |
|------|------|--------|
| --headless | æ˜¯å¦åœ¨æ— å¤´æ¨¡å¼ä¸‹è¿è¡Œ | True |
| --rl_device | RL è®¡ç®—è®¾å¤‡ | cuda:1 |
| --sim_device | ä»¿çœŸè®¾å¤‡ | cuda:1 |
| --compute_device_id | è®¡ç®—è®¾å¤‡ ID | 1 |
| --sim_device_id | ä»¿çœŸè®¾å¤‡ ID | 1 |
| --task | ä»»åŠ¡åç§°ï¼ˆå›ºå®šä¸º go2ï¼‰ | go2 |
| --resume | æ˜¯å¦ä» checkpoint æ¢å¤è®­ç»ƒ | False |
| --experiment_name | å®éªŒåç§° | high_level_go2 |
| --run_name | è¿è¡Œåç§° | è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æˆ³ |
| --num_envs | å¹¶è¡Œè®­ç»ƒç¯å¢ƒæ•°é‡ | 32 |
| --seed | éšæœºç§å­ | 42 |
| --max_iterations | æœ€å¤§è®­ç»ƒè¿­ä»£æ¬¡æ•° | 10000 |

### ğŸ“ ç¤ºä¾‹å‘½ä»¤

#### åŸºæœ¬è®­ç»ƒ
```bash
python legged_gym_go2/legged_gym/scripts/train_reach_avoid.py
```

#### æ— å¤´æ¨¡å¼è®­ç»ƒï¼ˆæ›´é«˜æ•ˆç‡ï¼‰
```bash
python legged_gym_go2/legged_gym/scripts/train_reach_avoid.py --headless=true
```

#### ä½¿ç”¨ä¸åŒ GPU
```bash
python legged_gym_go2/legged_gym/scripts/train_reach_avoid.py --rl_device=cuda:0 --sim_device=cuda:0 --compute_device_id=0 --sim_device_id=0
```

#### æ¢å¤è®­ç»ƒ
```bash
python legged_gym_go2/legged_gym/scripts/train_reach_avoid.py --resume=true --experiment_name=high_level_go2
```

#### å¯è§†åŒ–è®­ç»ƒæ•ˆæœ
```bash
python legged_gym_go2/legged_gym/scripts/play_reach_avoid.py
```

### ğŸ“„ é…ç½®æ–‡ä»¶

- ç¯å¢ƒé…ç½®ï¼š`GO2HighLevelCfg`
- è®­ç»ƒé…ç½®ï¼š`GO2HighLevelCfgPPO`
- å¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¦†ç›–é…ç½®å€¼

## ğŸ“Š è®­ç»ƒç»“æœ

### ğŸ“¤ è¾“å‡ºä¿¡æ¯

è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè„šæœ¬ä¼šè¾“å‡ºä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š

```
iter 00001 | success 0.000 | policy_loss -0.00123 | value_loss 0.12345 | Vmean 0.567 | Rmean 0.890 | Vrmse 0.123 | VexpVar 0.456 | adv_std 0.789 | elapsed 1.23s
```

### ğŸ’¾ ç”Ÿæˆæ–‡ä»¶

- **æ¨¡å‹æ£€æŸ¥ç‚¹**ï¼š`logs/<experiment_name>/<timestamp>/model_<iteration>.pt`
- **è®­ç»ƒæ—¥å¿—**ï¼šæ§åˆ¶å°è¾“å‡ºï¼Œå¯é‡å®šå‘åˆ°æ–‡ä»¶
- **GH å¿«ç…§**ï¼šï¼ˆå¯é€‰ï¼‰å®šæœŸä¿å­˜çš„çŠ¶æ€å¿«ç…§

## ğŸ“ é¡¹ç›®ç»“æ„

```
Go2HierarchicalReachAvoidRL/
â”œâ”€â”€ legged_gym_go2/
â”‚   â”œâ”€â”€ legged_gym/
â”‚   â”‚   â”œâ”€â”€ envs/
â”‚   â”‚   â”‚   â””â”€â”€ go2/
â”‚   â”‚   â”‚       â”œâ”€â”€ hierarchical_go2_env.py    # åˆ†å±‚ç¯å¢ƒå°è£…
â”‚   â”‚   â”‚       â”œâ”€â”€ high_level_navigation_env.py # é«˜å±‚çº§å¯¼èˆªç¯å¢ƒ
â”‚   â”‚   â”‚       â””â”€â”€ go2_env.py                   # åŸºç¡€ Go2 ç¯å¢ƒ
â”‚   â”‚   â”œâ”€â”€ scripts/
â”‚   â”‚   â”‚   â”œâ”€â”€ train_reach_avoid.py            # åˆ†å±‚é¿éšœä»»åŠ¡è®­ç»ƒè„šæœ¬
â”‚   â”‚   â”‚   â”œâ”€â”€ play_reach_avoid.py             # é¿éšœç­–ç•¥å¯è§†åŒ–è„šæœ¬
â”‚   â”‚   â”‚   â”œâ”€â”€ play_fixed_commands_with_video.py # å›ºå®šå‘½ä»¤æµ‹è¯•ä¸è§†é¢‘å½•åˆ¶è„šæœ¬
â”‚   â”‚   â”‚   â”œâ”€â”€ plot_env_layout.py              # ç¯å¢ƒå¸ƒå±€å¯è§†åŒ–è„šæœ¬
â”‚   â”‚   â”‚   â””â”€â”€ test_reach_avoid.py             # ç”Ÿæˆè½¨è¿¹å¹¶ä¿å­˜åˆ°JSONæ–‡ä»¶çš„æµ‹è¯•è„šæœ¬
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â””â”€â”€ rsl_rl/
â”‚       â”œâ”€â”€ algorithms/
â”‚       â”‚   â””â”€â”€ reach_avoid_ppo.py              # é¿éšœ PPO ç®—æ³•
â”‚       â””â”€â”€ modules/
â”‚           â””â”€â”€ actor_critic.py                 # ç­–ç•¥ç½‘ç»œ
â””â”€â”€ logs/                                       # è®­ç»ƒæ—¥å¿—å’Œæ¨¡å‹ä¿å­˜ç›®å½•
```

## ğŸ”„ è®­ç»ƒæµç¨‹è¯¦è§£

### ğŸŸ¢ 1. ç¯å¢ƒåˆ›å»º

`create_env` å‡½æ•°åˆ›å»ºåˆ†å±‚ç¯å¢ƒï¼š

```python
def create_env(env_cfg, train_cfg, args, device) -> HierarchicalVecEnv:
    base_env = HierarchicalGO2Env(
        cfg=env_cfg,
        low_level_model_path=train_cfg.runner.low_level_model_path,
        args=args,
        device=device,
    )
    return HierarchicalVecEnv(base_env)
```

### ğŸ“Š 2. ç»éªŒæ”¶é›†

è®­ç»ƒå¾ªç¯ä¸­ï¼Œè„šæœ¬æ”¶é›†å›ºå®šé•¿åº¦çš„è½¨è¿¹æ•°æ®ï¼š

```python
for step in range(horizon):
    actions, log_probs, values = alg.act(rollout_obs[step])
    next_obs, next_g, next_h, dones, _ = env.step(actions)
    # å­˜å‚¨è½¨è¿¹æ•°æ®
```

### âœ… 3. æˆåŠŸç‡è®¡ç®—

`compute_reach_avoid_success_rate` å‡½æ•°è¯„ä¼°é¿éšœä»»åŠ¡æˆåŠŸç‡ï¼š

```python
def compute_reach_avoid_success_rate(g_sequence, h_sequence) -> float:
    # g_sequence: ç›®æ ‡è¾¾æˆæŒ‡æ ‡åºåˆ—
    # h_sequence: éšœç¢ç‰©è§„é¿æŒ‡æ ‡åºåˆ—
    # è¿”å›æˆåŠŸç‡
```

### ï¿½ 4. ç­–ç•¥æ›´æ–°

ä½¿ç”¨ PPO ç®—æ³•æ›´æ–°é«˜å±‚çº§ç­–ç•¥ï¼š

```python
policy_loss, value_loss = alg.update()
```

## ğŸš€ æ‰©å±•ä¸è‡ªå®šä¹‰

### ğŸ—ï¸ 1. ä¿®æ”¹ç½‘ç»œæ¶æ„

åœ¨ `train_reach_avoid` å‡½æ•°ä¸­ä¿®æ”¹ç½‘ç»œå°ºå¯¸ï¼š

```python
train_cfg.policy.actor_hidden_dims = [512, 512, 512, 512]  # Actor ç½‘ç»œ
 train_cfg.policy.critic_hidden_dims = [512, 512, 512, 512]  # Critic ç½‘ç»œ
```

### âš™ï¸ 2. è°ƒæ•´è®­ç»ƒå‚æ•°

ä¿®æ”¹ `GO2HighLevelCfgPPO` é…ç½®ï¼š

- å­¦ä¹ ç‡
- æŠ˜æ‰£å› å­
- gae å‚æ•°
- æ‰¹é‡å¤§å°
- è®­ç»ƒè¿­ä»£æ¬¡æ•°

### ğŸŒ 3. è‡ªå®šä¹‰ç¯å¢ƒ

æ‰©å±• `HierarchicalGO2Env` ç±»æˆ–ä¿®æ”¹ `HighLevelNavigationConfig` é…ç½®ï¼Œè‡ªå®šä¹‰ç¯å¢ƒç‰¹æ€§ï¼š

- éšœç¢ç‰©ç±»å‹å’Œåˆ†å¸ƒ
- å¥–åŠ±å‡½æ•°
- è§‚æµ‹ç©ºé—´
- åŠ¨ä½œç©ºé—´

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

è®­ç»ƒè¿‡ç¨‹ä¸­ç›‘æ§çš„å…³é”®æŒ‡æ ‡ï¼š

- **æˆåŠŸç‡ï¼ˆsuccessï¼‰**ï¼šæˆåŠŸåˆ°è¾¾ç›®æ ‡ä¸”æœªç¢°æ’çš„ç¯å¢ƒæ¯”ä¾‹
- **ç­–ç•¥æŸå¤±ï¼ˆpolicy_lossï¼‰**ï¼šActor ç½‘ç»œçš„æŸå¤±å€¼
- **ä»·å€¼æŸå¤±ï¼ˆvalue_lossï¼‰**ï¼šCritic ç½‘ç»œçš„æŸå¤±å€¼
- **ä»·å€¼å‡å€¼ï¼ˆVmeanï¼‰**ï¼šä»·å€¼å‡½æ•°çš„å‡å€¼
- **å›æŠ¥å‡å€¼ï¼ˆRmeanï¼‰**ï¼šè½¨è¿¹å›æŠ¥çš„å‡å€¼
- **ä»·å€¼ RMSEï¼ˆVrmseï¼‰**ï¼šä»·å€¼å‡½æ•°é¢„æµ‹è¯¯å·®
- **è§£é‡Šæ–¹å·®ï¼ˆVexpVarï¼‰**ï¼šä»·å€¼å‡½æ•°è§£é‡Šå›æŠ¥å˜åŒ–çš„èƒ½åŠ›
- **ä¼˜åŠ¿æ ‡å‡†å·®ï¼ˆadv_stdï¼‰**ï¼šä¼˜åŠ¿å‡½æ•°çš„æ ‡å‡†å·®

## ğŸ¯ ç¤ºä¾‹åº”ç”¨åœºæ™¯

1. **å®¤å†…å¯¼èˆª**ï¼šåœ¨åŠå…¬å®¤æˆ–å®¶åº­ç¯å¢ƒä¸­è‡ªä¸»å¯¼èˆª
2. **ä»“å‚¨ç‰©æµ**ï¼šåœ¨ä»“åº“ç¯å¢ƒä¸­æ¬è¿ç‰©å“
3. **æœç´¢æ•‘æ´**ï¼šåœ¨å¤æ‚ç¯å¢ƒä¸­æœç´¢ç›®æ ‡
4. **ç¯å¢ƒç›‘æµ‹**ï¼šåœ¨ç‰¹å®šåŒºåŸŸå†…è¿›è¡Œç¯å¢ƒç›‘æµ‹

## ğŸ‰ è‡´è°¢

æœ¬ä»“åº“å¼€å‘ç¦»ä¸å¼€ä»¥ä¸‹å¼€æºé¡¹ç›®çš„æ”¯æŒä¸è´¡çŒ®ï¼Œç‰¹æ­¤æ„Ÿè°¢ï¼š
- [https://github.com/littlebearqqq/legged_gym_go2.git](https://github.com/littlebearqqq/legged_gym_go2.git): æ„å»ºè®­ç»ƒä¸è¿è¡Œä»£ç çš„åŸºç¡€ã€‚
- rsl_rl: å¼ºåŒ–å­¦ä¹ ç®—æ³•å®ç°ã€‚
- mujoco: æä¾›å¼ºå¤§ä»¿çœŸåŠŸèƒ½ã€‚
- unitree_sdk2_python: å®ç‰©éƒ¨ç½²ç¡¬ä»¶é€šä¿¡æ¥å£ã€‚

